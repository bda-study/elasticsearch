# Chapter02 기능 들여다보기

- 문서, 타입, 색인 정의하기
- 일래스틱서치 노드와 주(primary) 및 복제(replica) 샤드 이해하기
- cURL과 데이터 집합으로 문서 색인하기
- 데이터를 찾고 가져오기
- 일래스틱서치 환경설정 옵션 세팅하기
- 다수의 노드로 작업하기

## 2.0 Deprecated contents

- 현재 hombrew 패키지를 통하여 설치하면 elastic search version이 `6.8.4`이다. 책에서 소개한 소스코드는 `1.5` 기준이라서 syntax 및 예약어들이 변경이나 deprecated되어 애러가 발생하는 경우가 많다.~~(안 되는게 너무 많다...)~~

## 2.1 논리적인 배치 이해하기: 문서, 타입, 색인

- 애플리케이션과 관리자의 관점에서 본 일래스틱서치 클러스터
![그림2.1](https://user-images.githubusercontent.com/49108738/69000721-77618900-0917-11ea-8141-34b1c6e5c797.png)
- 일래스틱서치에서 데이터의 논리적 배치: 어떻게 애플리케이션이 데이터를 보는가
![그림2.2](https://user-images.githubusercontent.com/49108738/69000782-6ebd8280-0918-11ea-8edf-c3b42310e8c7.png)
- 문서
  - 독립적이다. 문서는 필드(name)와 값(Elasticsearch Denver)을 가지고 있다.
  - 계층을 가질 수 있다. 문서 안의 문서로 생각하자. 필드의 값은 위치 필드의 값이 문자열인 것과 같이 단순형일 수 있다. 다른 필드와 값들을 포함할 수도 있다. 예를들어, 위치 필드는 도시와 거리 주소 모두 포함할 수 있다.
  - 유연한 구조로 되어 있다. 여러분의 문서는 미리 정의한 스키마에 의존하지 않는다. 예를 들어, 모든 이벤트가 서술 값이 필요하지는 않아서 필드가 완전히 생략될 수 있다. 그러나 위치의 위도와 경도 같은 새로운 필드가 필요할지 모른다.
  - 문서는 보통 데이터의 JSON(JavaScript Object Notation) 표현이다.
- 타입
  - 문서에 대한 논리적인 컨테이너다.
  - 각 타입에서 필드의 정으는 매핑이라고 부른다.
  - 매핑은 타입에서 지금까지 색인한 모든 문서의 모든 필드를 포함한다.
  - 새로운 필드가 색인되면 자동으로 타입을 추측하여 매핑에 추가한다.
- 색인
  - 색인은 매핑 타입의 컨테이너다.
  - 각 색인은 `refresh_interval`이라는 설정으로 새로 색인한 문서를 검색할 수 있도록 간격을 정의한다.(default : 초당 1번)
  
## 2.2 물리적 배치 이해하기: 노드와 샤드

- 노드, 주 샤드, 복제(replica) 샤드 이해하기
![그림 2.3](https://user-images.githubusercontent.com/49108738/69001070-f8228400-091b-11ea-9b99-ea024bad21cf.png)
- 스플릿 브레인(split brain)이란? 클러스터를 구성하고 있는 노드 사이에 네트워크에 단절이 발생하여 마스터 후보 노드(master-eligible node)가 각각 마스터노트로 승격하여 하나의 클러스터가 2개의 sub 클러스터로 나뉘어지는 현상이다. 데이터 비동기화 문제가 발생하게 된다.
- 문서의 색인은 다음과 같은 과정으로 만들어진다.
  - 문서 ID의 hash 값에 기반하여 주 샤드에 보내진다.
  - 문서 ID의 hash 값은 주 샤드의 모든 복제 샤드에 색인하도록 보내진다.
- 색인을 검색할 때는 주 샤드와 복제 샤드에 관계없이 검색로드분배를 통해 실행된다.
- TF-IDF 스코어링(일래스틱서치의 기본값)
  - TF(term frequency) :  특정한 단어가 문서 내에 얼마나 자주 등장하는지를 나타내는 값
  - DF(document frequency) : 단어 자체가 문서군 내에서 자주 사용되는 경우, 이것은 그 단어가 흔하게 등장한다는 것을 의미
  - IDF(inverse document frequency) : DF값의 역수
